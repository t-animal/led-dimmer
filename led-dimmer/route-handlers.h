#pragma once

#include "Arduino.h"
#include <ESP8266WebServer.h>
#include <NTPClient.h>

#include "AutoConfig.h"
#include "number-parsing.h"
#include "logging.h"

extern ESP8266WebServer server;
extern unsigned int currentPercentage;
extern NTPClient timeClient;
extern Logger<1024> logger;

void httpServerHandleRoot();
void httpServerHandleNotFound();
void httpServerHandleDimValue();
void httpServerHandleTime();
void httpServerHandleTimeUpdate();
void httpServerHandleConfig(int index, AutoConfig& config);
void httpServerHandleLog();

const char* const indexPage = "<!doctype html><html><head><meta charset=\"utf-8\"><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"><title>LedDimmer config page</title><script type=\"module\">const p=location.origin!=\"localhost:3000\",i=p?\"http://leddimmer.fritz.box\":\"\";window.setCurrent=function(e){const t={\"Content-Type\":\"text/plain\"};fetch(`${i}/current`,{headers:t,method:\"POST\",body:e})};async function y(){const e=await(await fetch(`${i}/current`)).text(),t=document.querySelector(\"#manualInput\");t.value=e,t.nextElementSibling.value=e}window.getAndWriteLog=async function(){const e=await(await fetch(`${i}/log`)).text();document.querySelector(\"#log\").textContent=e};async function d(){const e=await(await fetch(`${i}/time`)).text();document.querySelector(\"#currentTime\").textContent=e}window.forceTimeUpdate=async function(){await fetch(`${i}/time/update`),d()};async function c(e){const t=await(await fetch(`${i}/config/${e}`)).json(),n=document.querySelector(`[data-config-index=\"${e}\"]`);n!==null&&(n.querySelector(\"[name=enabled]\").checked=t.enabled,n.querySelector(\"[name=startTime]\").value=t.startTime,n.querySelector(\"[name=endTime]\").value=t.endTime,n.querySelector(\"[name=percentage]\").value=t.percentage,n.querySelector(\".loading\").style.display=\"none\",n.querySelectorAll('input[name=\"daysOfWeek\"]').forEach(a=>a.checked=t.daysOfWeek.includes(a.value)),n.querySelectorAll('[type=\"time\"]').forEach(printEffective))}window.updateConfig=async function(e){document.querySelector(`[data-config-index=\"${e}\"] .loading`).style.display=\"block\";const t=document.querySelector(`[data-config-index=\"${e}\"] form`);if(t==null)return;const n=new URLSearchParams(new FormData(t));n.set(\"daysOfWeek\",n.getAll(\"daysOfWeek\").join(\",\")),await fetch(`${i}/config/${e}`,{method:\"POST\",body:n}),await c(e)};window.setCurrentManually=function(){var e,t;setCurrent((t=(e=document.querySelector(\"#manualInput\"))==null?void 0:e.value)!=null?t:\"\")};window.printEffective=function(e){var u,s,f,m;const t=new Date().getTimezoneOffset(),n=(s=(u=e.valueAsDate)==null?void 0:u.getUTCHours())!=null?s:0,a=(m=(f=e.valueAsDate)==null?void 0:f.getUTCMinutes())!=null?m:0,o=parseInt((n*60+a-t)/60%24),r=(n*60+a-t)%60,l=o.toString().padStart(2,\"0\")+\":\"+r.toString().padStart(2,\"0\");e.nextElementSibling.textContent=l};d();setInterval(d,1e4);getAndWriteLog();setInterval(getAndWriteLog,1e4);c(0);c(1);c(2);c(3);c(4);y();location.search.includes(\"mode=dark\")&&(document.querySelector(\"html\").dataset.mode=\"dark\");</script><style>html[data-mode=dark],html[data-mode=dark] button,html[data-mode=dark] input{color:#ddd;background-color:#222}html[data-mode=dark] button,html[data-mode=dark] input{background-color:#333;border:1px solid #ddd;border-radius:2px}@media (prefers-color-scheme:dark){button,html,input{color:#ddd;background-color:#222}button,input{background-color:#333;border:1px solid #ddd;border-radius:2px}}label{margin-right:5ex;white-space:nowrap}.days-of-week label{margin:0}.days-of-week label~label{margin-left:2ex}.auto-config-set{position:relative}.auto-config-set .loading{position:absolute;width:calc(100% - 15px);height:calc(100% - 15px);background:rgba(255,255,255,.9);font-size:1.5em}#log{width:100%;min-height:8em}</style></head><body><h1>LedDimmer</h1><fieldset><legend>Presets</legend><button onclick=\"setCurrent(100)\">An (100%)</button> <button onclick=\"setCurrent(70)\">An (70%)</button> <button onclick=\"setCurrent(30)\">An (30%)</button> <button onclick=\"setCurrent(0)\">Aus (0%)</button></fieldset><fieldset><legend>Manual</legend><input id=\"manualInput\" type=\"range\" min=\"0\" max=\"100\" value=\"-1\" oninput=\"this.nextElementSibling.value = this.value\"><output>---</output><button onclick=\"setCurrentManually()\">Setzen</button></fieldset><fieldset><legend>Datum und Uhrzeit</legend><span id=\"currentTime\">Lade...</span> (UTC) <button onclick=\"forceTimeUpdate()\">Force Update</button></fieldset><h2>Automatisiertes Schalten</h2><p>Beachte: Uhrzeiten m√ºssen in UTC angegeben werden (vergleiche Uhrzeit oben).</p><fieldset class=\"auto-config-set\" data-config-index=\"0\"><div class=\"loading\">Lade...</div><legend>Automatisches ein- und ausschalten Config 1</legend><form><label>Aktiviert <input type=\"checkbox\" name=\"enabled\"></label> <label>Anschalten um <input type=\"time\" name=\"startTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label> <label>Abschalten um <input type=\"time\" name=\"endTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label> <label>Wert <input type=\"number\" min=\"0\" max=\"100\" name=\"percentage\" required></label><br/><span class=\"days-of-week\">Aktiv am <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Mon\"/> Montag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Tue\"/> Dienstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Wed\"/> Mittwoch</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Thu\"/> Donnerstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Fri\"/> Freitag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sat\"/> Samstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sun\"/> Sonntag</label></span><br/><button onclick=\"updateConfig(0);return false;\">Speichern</button></form></fieldset><fieldset class=\"auto-config-set\" data-config-index=\"1\"><div class=\"loading\">Lade...</div><legend>Automatisches ein- und ausschalten Config 2</legend><form><label>Aktiviert <input type=\"checkbox\" name=\"enabled\"></label> <label>Anschalten um <input type=\"time\" name=\"startTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label> <label>Abschalten um <input type=\"time\" name=\"endTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label> <label>Wert <input type=\"number\" min=\"0\" max=\"100\" name=\"percentage\" required></label><br/><span class=\"days-of-week\">Aktiv am <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Mon\"/> Montag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Tue\"/> Dienstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Wed\"/> Mittwoch</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Thu\"/> Donnerstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Fri\"/> Freitag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sat\"/> Samstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sun\"/> Sonntag</label></span><br/><button onclick=\"updateConfig(1);return false;\">Speichern</button></form></fieldset><fieldset class=\"auto-config-set\" data-config-index=\"2\"><div class=\"loading\">Lade...</div><legend>Automatisches ein- und ausschalten Config 3</legend><form><label>Aktiviert <input type=\"checkbox\" name=\"enabled\"></label> <label>Anschalten um <input type=\"time\" name=\"startTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label> <label>Abschalten um <input type=\"time\" name=\"endTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label> <label>Wert <input type=\"number\" min=\"0\" max=\"100\" name=\"percentage\" required></label><br/><span class=\"days-of-week\">Aktiv am <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Mon\"/> Montag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Tue\"/> Dienstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Wed\"/> Mittwoch</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Thu\"/> Donnerstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Fri\"/> Freitag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sat\"/> Samstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sun\"/> Sonntag</label></span><br/><button onclick=\"updateConfig(2);return false;\">Speichern</button></form></fieldset><fieldset class=\"auto-config-set\" data-config-index=\"3\"><div class=\"loading\">Lade...</div><legend>Automatisches ein- und ausschalten Config 4</legend><form><label>Aktiviert <input type=\"checkbox\" name=\"enabled\"></label> <label>Anschalten um <input type=\"time\" name=\"startTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label> <label>Abschalten um <input type=\"time\" name=\"endTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label> <label>Wert <input type=\"number\" min=\"0\" max=\"100\" name=\"percentage\" required></label><br/><span class=\"days-of-week\">Aktiv am <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Mon\"/> Montag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Tue\"/> Dienstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Wed\"/> Mittwoch</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Thu\"/> Donnerstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Fri\"/> Freitag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sat\"/> Samstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sun\"/> Sonntag</label></span><br/><button onclick=\"updateConfig(3);return false;\">Speichern</button></form></fieldset><fieldset class=\"auto-config-set\" data-config-index=\"4\"><div class=\"loading\">Lade...</div><legend>Automatisches ein- und ausschalten Config 5</legend><form><label>Aktiviert <input type=\"checkbox\" name=\"enabled\"></label> <label>Anschalten um <input type=\"time\" name=\"startTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label> <label>Abschalten um <input type=\"time\" name=\"endTime\" required oninput=\"printEffective(this)\"> UTC (Lokal:<output></output>)</label>"
" <label>Wert <input type=\"number\" min=\"0\" max=\"100\" name=\"percentage\" required></label><br/><span class=\"days-of-week\">Aktiv am <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Mon\"/> Montag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Tue\"/> Dienstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Wed\"/> Mittwoch</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Thu\"/> Donnerstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Fri\"/> Freitag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sat\"/> Samstag</label> <label><input type=\"checkbox\" name=\"daysOfWeek\" value=\"Sun\"/> Sonntag</label></span><br/><button onclick=\"updateConfig(4);return false;\">Speichern</button></form></fieldset><fieldset><legend>Log output</legend><textarea readonly=\"readonly\" id=\"log\"></textarea></fieldset></body></html>";
const char* const contentType = "Content-Type";
