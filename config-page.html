<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>LedDimmer config page</title>
	<script>
		const urlBase='';
		/*const urlBase='http://leddimmer.fritz.box';*/

		function setCurrent(value) {
			const headers = {'Content-Type': 'text/plain'};
			fetch(
				`${urlBase}/current`, {
				headers,
				method: 'POST',
				body: value
			});
		}

		async function getAndWriteTime() {
			const time = await (await fetch(`${urlBase}/time`)).text();
			document.querySelector('#currentTime').textContent = time;
		}

		function forceTimeUpdate() {
			const time = fetch(`${urlBase}/time/update`);
			getAndWriteTime();
		}

		async function getAndWriteConfig(index) {
			const config = await (await fetch(`${urlBase}/config/${index}`)).json();
			document.querySelector(`[data-config-index="${index}"] [name=enabled]`).checked = config.enabled;
			document.querySelector(`[data-config-index="${index}"] [name=startTime]`).value = config.startTime;
			document.querySelector(`[data-config-index="${index}"] [name=endTime]`).value = config.endTime;
			document.querySelector(`[data-config-index="${index}"] [name=percentage]`).value = config.percentage;
			document.querySelector(`[data-config-index="${index}"] .loading`).style.display = 'none';
		}

		async function updateConfig(index) {
			document.querySelector(`[data-config-index="${index}"] .loading`).style.display = 'block';
			const form = document.querySelector(`[data-config-index="${index}"] form`);
			const data = new URLSearchParams(new FormData(form));
			await fetch(
				`${urlBase}/config/${index}`, {
				method: 'POST',
				body: data
			});
			await getAndWriteConfig(index);
		}

		function setCurrentManually() {
			setCurrent(document.querySelector('#manualInput').value);
		}

		getAndWriteTime();
		setInterval(getAndWriteTime, 10000);
		getAndWriteConfig(0);
		getAndWriteConfig(1);
		getAndWriteConfig(2);
		getAndWriteConfig(3);
		getAndWriteConfig(4);
	</script>

	<style>
		label {
			margin-right: 5ex;
			white-space: nowrap;
		}
		.auto-config-set { position: relative; }
		.auto-config-set .loading {
			position: absolute;
			width: calc(100% - 15px);
			height: calc(100% - 15px);
			background: rgba(255,255,255,0.9);
			font-size:  1.5em;
		}
	</style>
</head>
<body>
<h1>LedDimmer</h1>

<fieldset>
	<legend>Presets</legend>
	<button onclick="setCurrent(100)">An (100%)</button>
	<button onclick="setCurrent(70)">An (70%)</button>
	<button onclick="setCurrent(30)">An (30%)</button>
	<button onclick="setCurrent(0)">Aus (0%)</button>
</fieldset>

<fieldset>
	<legend>Manual</legend>
	<input id="manualInput" type="range" min="0" max="100" value="-1" oninput="this.nextElementSibling.value = this.value">
	<output>---</output>
	<button onclick="setCurrentManually()">Setzen</button>
</fieldset>

<fieldset>
	<legend>Datum und Uhrzeit</legend>
	<span id="currentTime">Lade...</span> (UTC)
	<button onclick="forceTimeUpdate()">Force Update</button>
</fieldset>

<h2>Automatisiertes Schalten</h2>

<p>Beachte: Uhrzeiten m√ºssen in UTC angegeben werden (vergleiche Uhrzeit oben).</p>

<!-- TODO: minimize using template? -->
<fieldset class="auto-config-set" data-config-index="0">
	<div class="loading">Lade...</div>
	<legend>Automatisches ein- und ausschalten Config 1</legend>
	<form action="/config/0" method="POST">
		<label>Aktiviert <input type="checkbox" name="enabled"></label>
		<label>Anschalten um <input type="time" name="startTime" required></label>
		<label>Abschalten um <input type="time" name="endTime" required></label>
		<label>Wert <input type="number" min="0" max="100" name="percentage" required></label>
		<button onclick="updateConfig(0);return false;" type="submit">Speichern</button>
	</form>
</fieldset>

<fieldset class="auto-config-set" data-config-index="1">
	<div class="loading">Lade...</div>
	<legend>Automatisches ein- und ausschalten Config 2</legend>
	<form action="/config/1" method="POST">
		<label>Aktiviert <input type="checkbox" name="enabled"></label>
		<label>Anschalten um <input type="time" name="startTime" required></label>
		<label>Abschalten um <input type="time" name="endTime" required></label>
		<label>Wert <input type="number" min="0" max="100" name="percentage" required></label>
		<button onclick="updateConfig(1);return false;" type="submit">Speichern</button>
	</form>
</fieldset>

<fieldset class="auto-config-set" data-config-index="2">
	<div class="loading">Lade...</div>
	<legend>Automatisches ein- und ausschalten Config 3</legend>
	<form action="/config/2" method="POST">
		<label>Aktiviert <input type="checkbox" name="enabled"></label>
		<label>Anschalten um <input type="time" name="startTime" required></label>
		<label>Abschalten um <input type="time" name="endTime" required></label>
		<label>Wert <input type="number" min="0" max="100" name="percentage" required></label>
		<button onclick="updateConfig(2);return false;" type="submit">Speichern</button>
	</form>
</fieldset>

<fieldset class="auto-config-set" data-config-index="3">
	<div class="loading">Lade...</div>
	<legend>Automatisches ein- und ausschalten Config 4</legend>
	<form action="/config/3" method="POST">
		<label>Aktiviert <input type="checkbox" name="enabled"></label>
		<label>Anschalten um <input type="time" name="startTime" required></label>
		<label>Abschalten um <input type="time" name="endTime" required></label>
		<label>Wert <input type="number" min="0" max="100" name="percentage" required></label>
		<button onclick="updateConfig(3);return false;" type="submit">Speichern</button>
	</form>
</fieldset>

<fieldset class="auto-config-set" data-config-index="4">
	<div class="loading">Lade...</div>
	<legend>Automatisches ein- und ausschalten Config 5</legend>
	<form action="/config/4" method="POST">
		<label>Aktiviert <input type="checkbox" name="enabled"></label>
		<label>Anschalten um <input type="time" name="startTime" required></label>
		<label>Abschalten um <input type="time" name="endTime" required></label>
		<label>Wert <input type="number" min="0" max="100" name="percentage" required></label>
		<button onclick="updateConfig(4);return false;" type="submit">Speichern</button>
	</form>
</fieldset>


</body>
</html>